input {
  beats {
    port => 5044
  }

  udp {
    port => 5959
    codec => json
  }
}

# filter {
# # https://github.com/vklochan/python-logstash
#     # Launching external script to make a deeper analysis
#     # if [file_path] =~ /.+/ {
#     #    ruby {
#     #     code => 'require "open3"
#     #              file_path = event.get("file_path")
#     #              cmd =  "/opt/bin/my_filter.py -f #{file_path}"
#     #              stdin, stdout, stderr = Open3.popen3(cmd)
#     #              event.set("process_result", stdout.read)
#     #              err = stderr.read
#     #              if err.to_s.empty?
#     #                filter_matched(event)
#     #              else
#     #                event.set("ext_script_err_msg", err)
#     #              end'
#     #       remove_field => ["file_path"]
#     #    }
#     # }
#     # Parsing of the process_result is here (see the next section)
#   # json {
#   #   source=>"message"
#   #   target=>"doc"
#   #   remove_field => message
#   # }
#   # mutate {gsub => [message, "[\\]{1}" ,""]}
# }

filter {
  #if [fields][log_type] == "access" {
  mutate {
    add_field => { "indicebase" => "%{[tags][0]}"}
    add_field => { "aplicacao" => "%{[tags][1]}"}
    remove_field => ["tags", "path"]
  }
  #}
}

output {
  elasticsearch {
    hosts => "elasticsearch:9200"
    manage_template => false
    #index => "%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}"
    index => "%{[indicebase]}-%{+YYYY.MM}"
    document_type => "%{[type]}" 
  }

  stdout {
    codec => rubydebug
  }

  file {
    codec => json
    path => "/mnt/dados.json"
  }
}

